<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Elytron: Secure WildFly CLI with Keycloak</title>
    <script src="/wildfly-elytron/assets/javascript/highlight.pack.js" type="text/javascript"></script>

    <link rel="shortcut icon" type="image/png" href="/wildfly-elytron/favicon.ico">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:300,400,500,700" type="text/css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <!-- We override the colours from this theme manually -->
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <link rel="stylesheet" href="/wildfly-elytron/assets/css/styles.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
    <script src="/wildfly-elytron/assets/javascript/hl.js" type="text/javascript"></script>
    <link rel="alternate" type="application/rss+xml"  href="/wildfly-elytron/feed.xml" title="WildFly Elytron">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-135301155-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-135301155-1');
    </script>
</head>
<body>


<!-- Always shows a header, even in smaller screens. -->
<div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
    <header class="mdl-layout__header mdl-layout__header--scroll">
        <div class="mdl-layout__header-row ">
            <!-- Title -->
            <span class="mdl-layout-title"><h3>Wild<strong>Fly</strong>  Elytron</h3></span>
            <!-- Add spacer, to align navigation to the right -->
            <div class="mdl-layout-spacer"></div>
            <nav class="mdl-navigation mdl-layout--large-screen-only">
                
                    
                    
                         <a class="mdl-navigation__link Home-menuitem" href="/wildfly-elytron/">Home</a>
                    
                
                    
                    
                         <a class="mdl-navigation__link Docs-menuitem" href="/wildfly-elytron/docs/">Docs</a>
                    
                
                    
                    
                         <a class="mdl-navigation__link Community-menuitem" href="/wildfly-elytron/community/">Community</a>
                    
                
                    
                    
                         <a class="mdl-navigation__link mdl-navigation__link--current Blog-menuitem" href="/wildfly-elytron/blog/">Blog</a>
                    
                
                    
                    
                         <a class="mdl-navigation__link GitHub-menuitem" href="https://github.com/wildfly-security/wildfly-elytron">GitHub</a>
                    
                
            </nav>
        </div>
    </header>
    <div class="mdl-layout__drawer">
        <div class="side-drawer-logo-container"><h3>Wild<strong>Fly</strong>  Elytron</h3></div>
        <nav class="mdl-navigation">
            
            
            
                <a class="mdl-navigation__link Home-menuitem" href="/wildfly-elytron/">Home</a>
            
            
            
            
                <a class="mdl-navigation__link Docs-menuitem" href="/wildfly-elytron/docs/">Docs</a>
            
            
            
            
                <a class="mdl-navigation__link Community-menuitem" href="/wildfly-elytron/community/">Community</a>
            
            
            
            
                <a class="mdl-navigation__link mdl-navigation__link--current Blog-menuitem" href="/wildfly-elytron/blog/">Blog</a>
            
            
            
            
                <a class="mdl-navigation__link GitHub-menuitem" href="https://github.com/wildfly-security/wildfly-elytron">GitHub</a>
            
            
            <!-- mdl-navigation__link--current -->
        </nav>
    </div>
    <main class="mdl-layout__content">
        <div class="page-content">
            
            <div class="content">
                <div class="post-page grid-wrapper">
  <div class="grid__item width-12-12 width-12-12-m doc-content">
    <h1>Secure WildFly CLI with Keycloak</h1>
    <div class="grid-wrapper">
      <div class="grid__item width-8-12 width-12-12-m byline-wrapper">
        
        
          <img class="headshot" src="https://www.gravatar.com/avatar/4336bee4b72f539ef5f8cc0d2c6026f5">
        
        <p class="byline">By <a href="https://github.com/Skyllarr">Diana Krepinska Vilkolakova</a> | June 15, 2021</p>
      </div>
      
      <div class="grid__item width-4-12 width-12-12-m"><div class="share-page">
  <a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://wildfly-security.github.io/wildfly-elytron/blog/secure-wildfly-cli-with-keycloak/&title=Secure WildFly CLI with Keycloak" rel="nofollow" target="_blank" title="Share on LinkedIn">
    <i class="fab fa-linkedin"></i>
  </a>
  <a class="share-twitter" href="https://twitter.com/intent/tweet?text=Secure WildFly CLI with Keycloak&url=https://wildfly-security.github.io/wildfly-elytron/blog/secure-wildfly-cli-with-keycloak/&via=WildFlyAS&related=WildFlyAS" rel="nofollow" target="_blank" title="Share on Twitter">
    <i class="fab fa-twitter-square"></i>
  </a>
  <a class="share-facebook" href="https://facebook.com/sharer.php?u=https://wildfly-security.github.io/wildfly-elytron/blog/secure-wildfly-cli-with-keycloak/" rel="nofollow" target="_blank" title="Share on Facebook">
    <i class="fab fa-facebook-square"></i>
  </a>
  <a class="share-reddit" href="http://www.reddit.com/submit?url=https://wildfly-security.github.io/wildfly-elytron/blog/secure-wildfly-cli-with-keycloak/" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit" >
    <i class="fab fa-reddit-square"></i>
  </a>
  <a class="share-email" href="mailto:?subject=Secure WildFly CLI with Keycloak&amp;body=Secure WildFly CLI with Keycloak https://wildfly-security.github.io/wildfly-elytron/blog/secure-wildfly-cli-with-keycloak/" title="Share via Email" >
    <i class="fas fa-envelope-square"></i>
  </a>
</div>
</div>
      <div class="grid__item width-12-12">
          <div class="paragraph">
<p>This blog post gives an example of how to secure WildFly CLI using Keycloak and Elytron.</p>
</div>
<div class="sect1">
<h2 id="keycloaks-wildfly-elytron-adapter"><a class="anchor" href="#keycloaks-wildfly-elytron-adapter"></a>Keycloak&#8217;s Wildfly Elytron Adapter</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Download WildFly server, Keycloak server and the WildFly OpenID Connect client adapter for WildFly from <a href="https://www.keycloak.org/downloads.html">keycloak.org</a>. Make sure your versions are compatible. Then, extract the contents of the client adapter into the root directory of your WildFly server.</p>
</div>
<div class="paragraph">
<p>Start WildFly on default port 8080:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$WILDFLY_HOME/bin/standalone.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>For Keycloak, use the following command to start the server on port 8180:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$KEYCLOAK_HOME/bin/standalone.sh -Djboss.socket.binding.port-offset=100</code></pre>
</div>
</div>
<div class="paragraph">
<p>Below script will make the necessary edits to the <code>$WILDFLY_HOME/standalone/configuration/standalone.xml</code> file in order to install the keycloak adapter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$WILDFLY_HOME/bin/jboss-cli.sh --file=$WILDFLY_HOME/bin/adapter-elytron-install-offline.cli</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should be able to access Keycloak Administration Console at <a href="http://localhost:8180/auth" class="bare">http://localhost:8180/auth</a>. If you are running the server for the first time, you should create an initial admin user to get started. Once you provide the username and password for the admin user you will be able to log in.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="keycloak-configuration"><a class="anchor" href="#keycloak-configuration"></a>Keycloak configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Create a realm with a name <code>wildfly-realm</code>. Then, create a client application with a name <code>wildfly-cli</code> and configure it as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Select <strong>confidential</strong> in the <strong>Access Type</strong> field</p>
</li>
<li>
<p>Put value <a href="http://localhost:9990/" class="bare">http://localhost:9990/</a> to <strong>Valid Redirect URI</strong> field</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="https://wildfly-security.github.io/wildfly-elytron/assets/images/posts/2021-06-15-secure-wildfly-cli-with-keycloak-WildFlyClientApp.png" alt="2021 06 15 secure wildfly cli with keycloak WildFlyClientApp">
</div>
</div>
<div class="paragraph">
<p>Now you need to create a user in <code>wildfly-realm</code>. Make sure you configure password for this user as well.</p>
</div>
<div class="paragraph">
<p>Create an <strong>ADMINISTRATOR</strong> role. You need to add this role to this user in order to grant him/her access to the Wildfly CLI.</p>
</div>
<div class="paragraph">
<p>Finally, you should configure the Keycloak realm to put roles in a top level field in the JWT roken. This is because Keycloak uses the claim <code>realm_access.roles</code> to map roles by default. Since we want to configure role decoder to take roles from the claim <code>Roles</code>, we need to configure Keycloak to use this claim as well. It is of course possible to configure some other claim as well.</p>
</div>
<div class="paragraph">
<p>To configure this in Keycloak, go to the client scopes and click on <code>roles</code>. You should be able to find <code>realm roles</code> in the <code>Mappers</code> tab. Change the <code>Token Claim Name</code> to be <code>Roles</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://wildfly-security.github.io/wildfly-elytron/assets/images/posts/2021-06-15-secure-wildfly-cli-with-keycloak-RealmRoles.png" alt="2021 06 15 secure wildfly cli with keycloak RealmRoles">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="wildfly-configuration"><a class="anchor" href="#wildfly-configuration"></a>WildFly configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Connect to the WildFly CLI and run the below commands. Make sure you change the <code>&lt;wildfly-cli-client-secret&gt;</code> to match the client secret of your <code>wildfly-cli</code> client. You can find it in the Keycloak Administration Console.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">/subsystem=elytron/token-realm=my-jwt-realm:add(oauth2-introspection={client-id=wildfly-cli,client-secret=&lt;wildfly-cli-client-secret&gt;,introspection-url="http://localhost:8180/auth/realms/wildfly-realm/protocol/openid-connect/token/introspect"})

/subsystem=elytron/simple-role-decoder=roles-attribute:add(attribute="Roles")

/subsystem=elytron/security-domain=my-jwt-domain:add(realms=[{realm=my-jwt-realm,role-decoder=roles-attribute}],permission-mapper=default-permission-mapper,default-realm=my-jwt-realm)

/subsystem=elytron/sasl-authentication-factory=my-sasl-auth:add(sasl-server-factory=configured,security-domain=my-jwt-domain,mechanism-configurations=[{mechanism-name=OAUTHBEARER,mechanism-realm-configurations=[{realm-name=my-jwt-realm}]}])

/core-service=management/management-interface=http-interface:write-attribute(name=http-upgrade.sasl-authentication-factory, value=my-sasl-auth)

reload</code></pre>
</div>
</div>
<div class="paragraph">
<p>Above commands configure the WildFly CLI to require token for authorization of users. All incoming tokens will be validated using Keycloak&#8217;s token introspection endpoint.</p>
</div>
<div class="paragraph">
<p>You will be asked to provide a token when trying to access WildFly CLI with <code>$WILDFLY_HOME/bin/jboss-cli.sh</code> client.
To obtain and provide a token, create a file <code>$WILDFLY_HOME/wildfly-config.xml</code> with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;configuration&gt;
    &lt;authentication-client xmlns="urn:elytron:client:1.6"&gt;
        &lt;authentication-rules&gt;
            &lt;rule use-configuration="myconfig"&gt;
            &lt;/rule&gt;
        &lt;/authentication-rules&gt;
        &lt;authentication-configurations&gt;
            &lt;configuration name="myconfig"&gt;
                &lt;credentials&gt;
                    &lt;oauth2-bearer-token
                            token-endpoint-uri="http://localhost:8180/auth/realms/wildfly-realm/protocol/openid-connect/token"&gt;
                        &lt;resource-owner-credentials name="administrator-user"&gt;
                            &lt;credential-store-reference clear-text="password"/&gt;
                        &lt;/resource-owner-credentials&gt;
                        &lt;client-credentials client-id="wildfly-cli"
                                            client-secret="&lt;wildfly-cli-client-secret&gt;"&gt;
                        &lt;/client-credentials&gt;
                    &lt;/oauth2-bearer-token&gt;
                &lt;/credentials&gt;
            &lt;/configuration&gt;
        &lt;/authentication-configurations&gt;
    &lt;/authentication-client&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make sure you configure your client secret accordingly and change the resource owner credentials to match the user you added to the <code>wildfly-cli</code> realm. This configuration ensures that the token will be obtained from Keycloak and subsequently sent to the WildFly CLI endpoint.</p>
</div>
<div class="paragraph">
<p>Now you can connect to the WildFly CLI with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$WILDFLY_HOME/bin/jboss-cli.sh -c -Dwildfly.config.url=$WILDFLY_HOME/wildfly-config.xml</code></pre>
</div>
</div>
</div>
</div>
      </div>
    </div>
  </div>
</div>

            </div>
        </div>
    </main>
</div>
</body>
</html>

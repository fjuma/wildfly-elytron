<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Elytron: WildFly Encrypted Expression Support</title>
    <script src="/wildfly-elytron/assets/javascript/highlight.pack.js" type="text/javascript"></script>

    <link rel="shortcut icon" type="image/png" href="/wildfly-elytron/favicon.ico">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:300,400,500,700" type="text/css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <!-- We override the colours from this theme manually -->
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <link rel="stylesheet" href="/wildfly-elytron/assets/css/styles.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
    <script src="/wildfly-elytron/assets/javascript/hl.js" type="text/javascript"></script>
    <link rel="alternate" type="application/rss+xml"  href="/wildfly-elytron/feed.xml" title="WildFly Elytron">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-135301155-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-135301155-1');
    </script>
</head>
<body>


<!-- Always shows a header, even in smaller screens. -->
<div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
    <header class="mdl-layout__header mdl-layout__header--scroll">
        <div class="mdl-layout__header-row ">
            <!-- Title -->
            <span class="mdl-layout-title"><h3>Wild<strong>Fly</strong>  Elytron</h3></span>
            <!-- Add spacer, to align navigation to the right -->
            <div class="mdl-layout-spacer"></div>
            <nav class="mdl-navigation mdl-layout--large-screen-only">
                
                    
                    
                         <a class="mdl-navigation__link Home-menuitem" href="/wildfly-elytron/">Home</a>
                    
                
                    
                    
                         <a class="mdl-navigation__link Docs-menuitem" href="/wildfly-elytron/docs/">Docs</a>
                    
                
                    
                    
                         <a class="mdl-navigation__link Community-menuitem" href="/wildfly-elytron/community/">Community</a>
                    
                
                    
                    
                         <a class="mdl-navigation__link mdl-navigation__link--current Blog-menuitem" href="/wildfly-elytron/blog/">Blog</a>
                    
                
                    
                    
                         <a class="mdl-navigation__link GitHub-menuitem" href="https://github.com/wildfly-security/wildfly-elytron">GitHub</a>
                    
                
            </nav>
        </div>
    </header>
    <div class="mdl-layout__drawer">
        <div class="side-drawer-logo-container"><h3>Wild<strong>Fly</strong>  Elytron</h3></div>
        <nav class="mdl-navigation">
            
            
            
                <a class="mdl-navigation__link Home-menuitem" href="/wildfly-elytron/">Home</a>
            
            
            
            
                <a class="mdl-navigation__link Docs-menuitem" href="/wildfly-elytron/docs/">Docs</a>
            
            
            
            
                <a class="mdl-navigation__link Community-menuitem" href="/wildfly-elytron/community/">Community</a>
            
            
            
            
                <a class="mdl-navigation__link mdl-navigation__link--current Blog-menuitem" href="/wildfly-elytron/blog/">Blog</a>
            
            
            
            
                <a class="mdl-navigation__link GitHub-menuitem" href="https://github.com/wildfly-security/wildfly-elytron">GitHub</a>
            
            
            <!-- mdl-navigation__link--current -->
        </nav>
    </div>
    <main class="mdl-layout__content">
        <div class="page-content">
            
            <div class="content">
                <div class="post-page grid-wrapper">
  <div class="grid__item width-12-12 width-12-12-m doc-content">
    <h1>WildFly Encrypted Expression Support</h1>
    <div class="grid-wrapper">
      <div class="grid__item width-8-12 width-12-12-m byline-wrapper">
        
        
          <img class="headshot" src="https://www.gravatar.com/avatar/0898ff20f647b8c230f26f9bb3eb7003">
        
        <p class="byline">By <a href="https://github.com/darranl">Darran Lofthouse</a> | March 19, 2021</p>
      </div>
      
      <div class="grid__item width-4-12 width-12-12-m"><div class="share-page">
  <a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://wildfly-security.github.io/wildfly-elytron/blog/wildfly-encrypted-expressions/&title=WildFly Encrypted Expression Support" rel="nofollow" target="_blank" title="Share on LinkedIn">
    <i class="fab fa-linkedin"></i>
  </a>
  <a class="share-twitter" href="https://twitter.com/intent/tweet?text=WildFly Encrypted Expression Support&url=https://wildfly-security.github.io/wildfly-elytron/blog/wildfly-encrypted-expressions/&via=WildFlyAS&related=WildFlyAS" rel="nofollow" target="_blank" title="Share on Twitter">
    <i class="fab fa-twitter-square"></i>
  </a>
  <a class="share-facebook" href="https://facebook.com/sharer.php?u=https://wildfly-security.github.io/wildfly-elytron/blog/wildfly-encrypted-expressions/" rel="nofollow" target="_blank" title="Share on Facebook">
    <i class="fab fa-facebook-square"></i>
  </a>
  <a class="share-reddit" href="http://www.reddit.com/submit?url=https://wildfly-security.github.io/wildfly-elytron/blog/wildfly-encrypted-expressions/" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit" >
    <i class="fab fa-reddit-square"></i>
  </a>
  <a class="share-email" href="mailto:?subject=WildFly Encrypted Expression Support&amp;body=WildFly Encrypted Expression Support https://wildfly-security.github.io/wildfly-elytron/blog/wildfly-encrypted-expressions/" title="Share via Email" >
    <i class="fas fa-envelope-square"></i>
  </a>
</div>
</div>
      <div class="grid__item width-12-12">
          <div class="paragraph">
<p>With the release of WildFly 23 the WildFly Elytron project and it&#8217;s integration now adds support for
encrypted expressions within the management model, this post will describe the steps to quickly get
started using this new feature.</p>
</div>
<div class="sect1">
<h2 id="introduction"><a class="anchor" href="#introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>CredentialStore</code> functionality provided by WildFly Elytron provides a mechanism for the secure
storage of credentials that can be cross referenced by WildFly&#8217;s management model to avoid storing
the credentials directly in the configuration.</p>
</div>
<div class="paragraph">
<p>Using the credential store however leaves us with two remaining problems:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How to protect the secret of the credential store.</p>
</li>
<li>
<p>How to protect other configuration values.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Within WildFly in addition to specifying a clear text password to unlock the credential store an
administrator can configure the server to run an external command to obtain the password or the
administrator can MASK the password.  The issue with the masked password support however is this
uses password based encryption using a well know password publicly available in open source
projects.</p>
</div>
<div class="paragraph">
<p>The encrypted expression support added to WildFly solves both of these problems.  Firstly by adding
support for loading <code>SecretKey</code> instances from the credential store including a new clear store.
Secondly by adding support for values contained in the model to be encrypted and dynamically
decrypted using the stored keys.</p>
</div>
<div class="paragraph">
<p>The first part of this blog post will illustrate the commands to get started with encrypted
expressions using an automatically generated <code>SecretKey</code>.  The second part of this post will
illustrate how an encrypted expression can be used to protect a second credential store which in
turn will have a <code>SecretKey</code> added and enabled for use with expression encryption.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="initial-encrypted-expression-support"><a class="anchor" href="#initial-encrypted-expression-support"></a>Initial Encrypted Expression Support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Starting with a clean and running WildFly 23 (or later) installation, the examples in this post
will make use of the <code>jboss-cli</code> to configure the server.</p>
</div>
<div class="paragraph">
<p>Before we begin it is worth noting that by default the CLI will cache all executed commands in it&#8217;s
history, as these examples are going to be encrypting clear text passwords we should disable
history for our session.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">[standalone@localhost:9990 /] history --disable</code></pre>
</div>
</div>
<div class="paragraph">
<p>First we will add a new credential store which will be automatically be populated with a
dynamically <code>SecretKey</code> and stored under the alias <code>key</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">[standalone@localhost:9990 /] /subsystem=elytron/secret-key-credential-store=initial:add( \
    relative-to=jboss.server.config.dir, \
    path=initial.cs)
{"outcome" =&gt; "success"}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will create a new credential store <code>initial.cs</code> in the configuration directory of your
application server installation.  If a key is lost we do not have the ability to recover previously
encrypted expressions so be sure to backup the credential store or export the key and store it
safely.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">[standalone@localhost:9990 /] /subsystem=elytron/secret-key-credential-store=initial:export-secret-key(\
    alias=key)
{
    "outcome" =&gt; "success",
    "result" =&gt; {"key" =&gt; "RUxZAUuMVPg8wefEp0KTvGJfRrmwWwGIql2px7MKAbwV3gW3bg=="}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>This credential store is not protected by it&#8217;s own password so filesystem permissions should
be used to ensure it is only accessible by the application server process.</strong></p>
</div>
<div class="paragraph">
<p>Now that we have a generated secret key in a credential store we can activate the resource responsible
for handling encrypted expressions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">[standalone@localhost:9990 /] /subsystem=elytron/expression=encryption:add( \
    resolvers=[{name=initial-resolver, \
                credential-store=initial, \
                secret-key=key}])
{"outcome" =&gt; "success"}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Support for encrypted expressions is now active, we can now encrypt a clear text value and convert
it to an expression.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">[standalone@localhost:9990 /] /subsystem=elytron/expression=encryption:create-expression( \
    resolver=initial-resolver, clear-text=MyPassword)
{
    "outcome" =&gt; "success",
    "result" =&gt; {"expression" =&gt; \
        "${ENC::initial-resolver:RUxZAUMQEH6CP3xXyAqYzqsC3oNayyeGH32wsdAZ8VLkkxaEmWc=}"}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The expression returned here can be used on any attribute in other subsystems which supports
expressions.  The <code>read-resource-description</code> operation can be used on a resource to identify
if it&#8217;s attributes support expressions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">[standalone@localhost:9990 /] /subsystem=elytron/dir-context=*:read-resource-description
{
    "outcome" =&gt; "success",
    "result" =&gt; [{
        "address" =&gt; [
            ("subsystem" =&gt; "elytron"),
            ("dir-context" =&gt; "*")
        ],
....
                "properties" =&gt; {
                    "type" =&gt; OBJECT,
                    "description" =&gt; "The additional connection properties for the DirContext.",

                   "expressions-allowed" =&gt; true,

                },
....</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where an attribute specifies <code>expressions-allowed</code> is set to <code>true</code> these encrypted expressions can be used.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="second-credential-store"><a class="anchor" href="#second-credential-store"></a>Second Credential Store</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now we have a password converted to an encrypted expression we can define a new credential store using this
password and we can also add a <code>SecretKey</code> to the second store.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">[standalone@localhost:9990 /] /subsystem=elytron/credential-store=main:add( \
    relative-to=jboss.server.config.dir, \
    path=main.cs, \
    credential-reference= \
        {clear-text="${ENC::initial-resolver:RUxZAUMQEH6CP3xXyAqYzqsC3oNayyeGH32wsdAZ8VLkkxaEmWc=}"}, \
    create=true)
{"outcome" =&gt; "success"}

[standalone@localhost:9990 /] /subsystem=elytron/credential-store=main:generate-secret-key( \
    alias=main-key)
{"outcome" =&gt; "success"}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A second resolver can now be added to the <code>expression=resolver</code> resource, we can also make this new
resolver a default.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">[standalone@localhost:9990 /] /subsystem=elytron/expression=encryption:list-add(\
    name=resolvers, \
    value={ \
        name=main-resolver, \
        credential-store=main, \
        secret-key=main-key})

....

[standalone@localhost:9990 /] /subsystem=elytron/expression=encryption:write-attribute( \
    name=default-resolver, \
    value=main-resolver)

''''

[standalone@localhost:9990 /] :reload

....</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally we can use this new resolver to create an expression.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">[standalone@localhost:9990 /] /subsystem=elytron/expression=encryption:create-expression( \
    clear-text=MySecondPassword)
{
    "outcome" =&gt; "success",
    "result" =&gt; { \
        "expression" =&gt; "${ENC::RUxZAUMQLRoRLS2PYwFgxXlFTNvTaaI5GXO7qkY4W7UHCwGgUl9Vr4R1BKgm+SKfb4DCwuHf}
"}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As we defined a <code>default-resolver</code> this was omitted in the <code>create-expression</code> operation,
additionally the name of the resolver is not included in the resulting expression.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="xml-configuration"><a class="anchor" href="#xml-configuration"></a>XML Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The commands executed in this post have resulted in the following resources being defined in the
<code>elytron</code> subsystem.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;credential-stores&gt;
    &lt;credential-store name="main" relative-to="jboss.server.config.dir" path="main.cs" create="true"&gt;
        &lt;credential-reference
            clear-text="${ENC::initial-resolver:RUxZAUMQEH6CP3xXyAqYzqsC3oNayyeGH32wsdAZ8VLkkxaEmWc=}"/&gt;
    &lt;/credential-store&gt;
    &lt;secret-key-credential-store name="initial" relative-to="jboss.server.config.dir" path="initial.cs"/&gt;
&lt;/credential-stores&gt;
&lt;expression-resolver default-resolver="main-resolver"&gt;
    &lt;resolver name="initial-resolver" credential-store="initial" secret-key="key"/&gt;
    &lt;resolver name="main-resolver" credential-store="main" secret-key="main-key"/&gt;
&lt;/expression-resolver&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="further-reading"><a class="anchor" href="#further-reading"></a>Further Reading</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This blog post has illustrated the use of this new feature using a specific scenario, further
information is available in the WildFly documentation including information using the stand alone
command line tooling.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.wildfly.org/23/WildFly_Elytron_Security.html#CredentialStore" target="_blank" rel="noopener">WildFly Elytron Credential Store</a></p>
</li>
<li>
<p><a href="https://docs.wildfly.org/23/WildFly_Elytron_Security.html#EncryptedExpressions" target="_blank" rel="noopener">Encrypted Expressions</a></p>
</li>
</ul>
</div>
</div>
</div>
      </div>
    </div>
  </div>
</div>

            </div>
        </div>
    </main>
</div>
</body>
</html>

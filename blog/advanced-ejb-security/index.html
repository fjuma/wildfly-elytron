<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Elytron: Advanced EJB: Securing EJBs using a FileSystem realm and invoking them from a remote client using a credential store</title>
    <script src="/wildfly-elytron/assets/javascript/highlight.pack.js" type="text/javascript"></script>

    <link rel="shortcut icon" type="image/png" href="/wildfly-elytron/favicon.ico">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:300,400,500,700" type="text/css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <!-- We override the colours from this theme manually -->
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <link rel="stylesheet" href="/wildfly-elytron/assets/css/styles.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
    <script src="/wildfly-elytron/assets/javascript/hl.js" type="text/javascript"></script>
    <link rel="alternate" type="application/rss+xml"  href="/wildfly-elytron/feed.xml" title="WildFly Elytron">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-135301155-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-135301155-1');
    </script>
</head>
<body>


<!-- Always shows a header, even in smaller screens. -->
<div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
    <header class="mdl-layout__header mdl-layout__header--scroll">
        <div class="mdl-layout__header-row ">
            <!-- Title -->
            <span class="mdl-layout-title"><h3>Wild<strong>Fly</strong>  Elytron</h3></span>
            <!-- Add spacer, to align navigation to the right -->
            <div class="mdl-layout-spacer"></div>
            <nav class="mdl-navigation mdl-layout--large-screen-only">
                
                    
                    
                         <a class="mdl-navigation__link Home-menuitem" href="/wildfly-elytron/">Home</a>
                    
                
                    
                    
                         <a class="mdl-navigation__link Docs-menuitem" href="/wildfly-elytron/docs/">Docs</a>
                    
                
                    
                    
                         <a class="mdl-navigation__link Community-menuitem" href="/wildfly-elytron/community/">Community</a>
                    
                
                    
                    
                         <a class="mdl-navigation__link mdl-navigation__link--current Blog-menuitem" href="/wildfly-elytron/blog/">Blog</a>
                    
                
                    
                    
                         <a class="mdl-navigation__link GitHub-menuitem" href="https://github.com/wildfly-security/wildfly-elytron">GitHub</a>
                    
                
            </nav>
        </div>
    </header>
    <div class="mdl-layout__drawer">
        <div class="side-drawer-logo-container"><h3>Wild<strong>Fly</strong>  Elytron</h3></div>
        <nav class="mdl-navigation">
            
            
            
                <a class="mdl-navigation__link Home-menuitem" href="/wildfly-elytron/">Home</a>
            
            
            
            
                <a class="mdl-navigation__link Docs-menuitem" href="/wildfly-elytron/docs/">Docs</a>
            
            
            
            
                <a class="mdl-navigation__link Community-menuitem" href="/wildfly-elytron/community/">Community</a>
            
            
            
            
                <a class="mdl-navigation__link mdl-navigation__link--current Blog-menuitem" href="/wildfly-elytron/blog/">Blog</a>
            
            
            
            
                <a class="mdl-navigation__link GitHub-menuitem" href="https://github.com/wildfly-security/wildfly-elytron">GitHub</a>
            
            
            <!-- mdl-navigation__link--current -->
        </nav>
    </div>
    <main class="mdl-layout__content">
        <div class="page-content">
            
            <div class="content">
                <div class="post-page grid-wrapper">
  <div class="grid__item width-12-12 width-12-12-m doc-content">
    <h1>Advanced EJB: Securing EJBs using a FileSystem realm and invoking them from a remote client using a credential store</h1>
    <div class="grid-wrapper">
      <div class="grid__item width-8-12 width-12-12-m byline-wrapper">
        
        
          <img class="headshot" src="https://www.gravatar.com/avatar/abf96d05af53c494685384d382dba345">
        
        <p class="byline">By <a href="https://github.com/SoniaZaldana">Sonia Zaldana Calles</a> | June 11, 2020</p>
      </div>
      
      <div class="grid__item width-4-12 width-12-12-m"><div class="share-page">
  <a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://wildfly-security.github.io/wildfly-elytron/blog/advanced-ejb-security/&title=Advanced EJB: Securing EJBs using a FileSystem realm and invoking them from a remote client using a credential store" rel="nofollow" target="_blank" title="Share on LinkedIn">
    <i class="fab fa-linkedin"></i>
  </a>
  <a class="share-twitter" href="https://twitter.com/intent/tweet?text=Advanced EJB: Securing EJBs using a FileSystem realm and invoking them from a remote client using a credential store&url=https://wildfly-security.github.io/wildfly-elytron/blog/advanced-ejb-security/&via=WildFlyAS&related=WildFlyAS" rel="nofollow" target="_blank" title="Share on Twitter">
    <i class="fab fa-twitter-square"></i>
  </a>
  <a class="share-facebook" href="https://facebook.com/sharer.php?u=https://wildfly-security.github.io/wildfly-elytron/blog/advanced-ejb-security/" rel="nofollow" target="_blank" title="Share on Facebook">
    <i class="fab fa-facebook-square"></i>
  </a>
  <a class="share-reddit" href="http://www.reddit.com/submit?url=https://wildfly-security.github.io/wildfly-elytron/blog/advanced-ejb-security/" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit" >
    <i class="fab fa-reddit-square"></i>
  </a>
  <a class="share-email" href="mailto:?subject=Advanced EJB: Securing EJBs using a FileSystem realm and invoking them from a remote client using a credential store&amp;body=Advanced EJB: Securing EJBs using a FileSystem realm and invoking them from a remote client using a credential store https://wildfly-security.github.io/wildfly-elytron/blog/advanced-ejb-security/" title="Share via Email" >
    <i class="fas fa-envelope-square"></i>
  </a>
</div>
</div>
      <div class="grid__item width-12-12">
          <div class="paragraph">
<p>The <strong><a href="https://github.com/wildfly-security-incubator/elytron-examples/tree/master/ejb-security">ejb-security</a></strong> quickstart demonstrates an advanced example on how to secure EJBs using a FileSystem realm with
SCRAM-SHA-512 SASL authentication along with a client credential store. The focus is on the Elytron
configuration, so if you wish to learn more about using Jakarta EE declarative security to control access to EJBs please
refer to this <a href="https://developer.jboss.org/people/fjuma/blog/2017/09/08/getting-started-with-ejbs-and-elytron-part-1">blog</a>.</p>
</div>
<div class="sect1">
<h2 id="an-overview-of-the-filesystem-realm"><a class="anchor" href="#an-overview-of-the-filesystem-realm"></a>An Overview of the FileSystem Realm</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By default, when using the Elytron security subsystem, our application uses a properties file-based identity store.
In this example, we wish to use a FileSystem realm which stores the identity information on a FileSystem by paging each identity in an XML
along with its credentials and roles.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuring-a-filesystem-realm"><a class="anchor" href="#configuring-a-filesystem-realm"></a>Configuring a FileSystem Realm</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We start our configuration by connecting to the server using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ WILDFLY_HOME/bin/jboss-cli.sh --connect</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="note-use-of-wildfly_home"><a class="anchor" href="#note-use-of-wildfly_home"></a>Note: Use of WILDFLY_HOME</h5>
<div class="paragraph">
<p>In the following post, replace <code>WILDFLY_HOME</code> with the actual path to your WildFly installation.</p>
</div>
<div class="paragraph">
<p>We then create a FileSystem realm under the Elytron subsystem by specifying a directory where to store these identities. Notice
in this case, we are storing the identities in a directory called <code>fs-realm-users</code> relative to <code>jboss.server.config.dir</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">/subsystem=elytron/filesystem-realm=fsRealm:add(path=fs-realm-users, relative-to=jboss.server.config.dir)</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can then add an identity, along with its password and role. For the implementation of this example, we need an identity
<code>quickstartUser</code>, whose password is <code>quickstartPwd1!</code> and whose Role is <code>guest</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">/subsystem=elytron/filesystem-realm=fsRealm:add-identity(identity=quickstartUser)

/subsystem=elytron/filesystem-realm=fsRealm:set-password(clear={password=quickstartPwd1!}, identity=quickstartUser)

/subsystem=elytron/filesystem-realm=fsRealm:add-identity-attribute(identity=quickstartUser, name=Roles, value=[guest])</code></pre>
</div>
</div>
<div class="paragraph">
<p>We then add a role decoder which will convert attributes from the identity provided by the security realm into roles:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">/subsystem=elytron/simple-role-decoder=from-roles-attribute:add(attribute=Roles)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more information about creating FileSystem realms along with all of its possible configurations,
please refer to the <a href="https://docs.wildfly.org/20/WildFly_Elytron_Security.html">Elytron documentation</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuring-the-security-domain"><a class="anchor" href="#configuring-the-security-domain"></a>Configuring the Security Domain</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We first configure an Elytron security domain called <code>fsSD</code> to use the FileSystem realm and role decoder we specified
as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">/subsystem=elytron/security-domain=fsSD:add(realms=[{realm=fsRealm, role-decoder=from-roles-attribute}], default-realm=fsRealm,permission-mapper=default-permission-mapper)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that creating an additional security domain (<code>fsSD</code> in this case) is not necessary. We could alternatively take the default <code>ApplicationDomain</code> and add the
FileSystem realm, role-decoder and permission-mapper to it.</p>
</div>
<div class="paragraph">
<p>We configure a security domain <code>other</code> in our EJB (as demonstrated by the <code>@SecurityDomain</code>
annotation). Since security for EJBs is handled by legacy security subsystems when deploying with WildFly,
we need to configure the security subsystem to be handled by Elytron by adding our security domain mapping in the
EJB subsystem as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">/subsystem=ejb3/application-security-domain=other:add(security-domain=fsSD)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="enabling-scram-sha-512"><a class="anchor" href="#enabling-scram-sha-512"></a>Enabling SCRAM-SHA-512</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Multiple authentication mechanisms can be configured for different protocols. Elytron provides support for two types of
authentication: <code>HTTP authentication</code> and <code>SASL  authentication</code>. We want our SASL authentication factory to make
use of the FileSystem security domain we configured. Therefore, we add said security domain as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">/subsystem=elytron/sasl-authentication-factory=application-sasl-authentication:write-attribute(name=security-domain, value=fsSD)</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, our authentication factory has enabled <code>JBOSS-LOCAL-USER</code> and <code>DIGEST-MD5</code>. Therefore, we enable <code>SCRAM-SHA-512</code>
as an additional SASL authentication mechanism by updating the
<code>sasl-authentication-factory</code> as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">/subsystem=elytron/sasl-authentication-factory=application-sasl-authentication:list-add(name=mechanism-configurations, value={mechanism-name=SCRAM-SHA-512})</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, we update the http-remoting-connector to use our updated <code>application-sasl-authentication-factory</code> as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">/subsystem=remoting/http-connector=http-remoting-connector:write-attribute(name=sasl-authentication-factory,value=application-sasl-authentication).</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuring-the-credential-store"><a class="anchor" href="#configuring-the-credential-store"></a>Configuring the Credential Store</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For the purpose of this example, we aim to provide a more secure setup than specifying the client&#8217;s password in
clear-text in the <code>wildfly-config.xml</code> file. As a result, we create a credential store locally as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"> $ WILDFLY_HOME/bin/elytron-tool.sh credential-store --create --location "/PATH/TO/mycredstore.cs" --password StorePassword</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note this creates a credential store <code>mycredstore.cs</code> locally with a corresponding password <code>StorePassword</code>. We then
add an alias (<code>quickstartUser</code>) storing the password (<code>quickstartPwd1!</code>) to be used for the authentication configuration as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"> $ WILDFLY_HOME/bin/elytron-tool.sh credential-store --location "/PATH/TO/mycredstore.cs" --password StorePassword --add quickstartUser --secret quickstartPwd1!</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuring-the-client-wildfly-config-xml"><a class="anchor" href="#configuring-the-client-wildfly-config-xml"></a>Configuring the Client (wildfly-config.xml)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Upon inspecting our <code>wildfly-config.xml</code>, notice how the credential store to be used by the authentication client is
specified:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">&lt;credential-stores&gt;
    &lt;credential-store name="mycredstore"&gt;
        &lt;attributes&gt;
            &lt;attribute name="keyStoreType" value="JCEKS"/&gt;
            &lt;attribute name="location" value="PATH/TO/mycredstore.cs"&gt;&lt;/attribute&gt;
        &lt;/attributes&gt;
            &lt;protection-parameter-credentials&gt;
                &lt;clear-password password="StorePassword"/&gt;
        &lt;/protection-parameter-credentials&gt;
    &lt;/credential-store&gt;
&lt;/credential-stores&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note you would need to replace <code>"PATH/TO/mycredstore.cs"</code> with the actual path to your credential store.</p>
</div>
<div class="paragraph">
<p>Then, notice the reference to our credential store along with the alias to extract the password from, and the
specification of the desired authentication mechanism under the <code>&lt;authentication-configurations&gt;</code> tag:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">&lt;authentication-configurations&gt;
    &lt;configuration name="default-config"&gt;
        &lt;set-user-name name="quickstartUser"/&gt;
        &lt;credentials&gt;
            &lt;credential-store-reference store="mycredstore" alias="quickstartUser"/&gt;
        &lt;/credentials&gt;
        &lt;sasl-mechanism-selector selector="SCRAM-SHA-512"/&gt;
        &lt;providers&gt;
            &lt;use-service-loader /&gt;
        &lt;/providers&gt;
    &lt;/configuration&gt;
&lt;/authentication-configurations&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also, note the <code>&lt;providers&gt;</code> tag which will result in the Elytron providers being registered.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="summary"><a class="anchor" href="#summary"></a>Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this blog post, we have taken a look at FileSystem realms, SCRAM-SHA-512 authentication and client credential
stores. This post described how to configure these components in relation to EJB security.</p>
</div>
</div>
</div>
      </div>
    </div>
  </div>
</div>

            </div>
        </div>
    </main>
</div>
</body>
</html>

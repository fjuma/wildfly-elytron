<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Elytron: Installing Keycloak OIDC adaptor using the Galleon CLI</title>
    <script src="/wildfly-elytron/assets/javascript/highlight.pack.js" type="text/javascript"></script>

    <link rel="shortcut icon" type="image/png" href="/wildfly-elytron/favicon.ico">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:300,400,500,700" type="text/css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <!-- We override the colours from this theme manually -->
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <link rel="stylesheet" href="/wildfly-elytron/assets/css/styles.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
    <script src="/wildfly-elytron/assets/javascript/hl.js" type="text/javascript"></script>
    <link rel="alternate" type="application/rss+xml"  href="/wildfly-elytron/feed.xml" title="WildFly Elytron">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-135301155-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-135301155-1');
    </script>
</head>
<body>


<!-- Always shows a header, even in smaller screens. -->
<div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
    <header class="mdl-layout__header mdl-layout__header--scroll">
        <div class="mdl-layout__header-row ">
            <!-- Title -->
            <span class="mdl-layout-title"><h3>Wild<strong>Fly</strong>  Elytron</h3></span>
            <!-- Add spacer, to align navigation to the right -->
            <div class="mdl-layout-spacer"></div>
            <nav class="mdl-navigation mdl-layout--large-screen-only">
                
                    
                    
                         <a class="mdl-navigation__link Home-menuitem" href="/wildfly-elytron/">Home</a>
                    
                
                    
                    
                         <a class="mdl-navigation__link Docs-menuitem" href="/wildfly-elytron/docs/">Docs</a>
                    
                
                    
                    
                         <a class="mdl-navigation__link Community-menuitem" href="/wildfly-elytron/community/">Community</a>
                    
                
                    
                    
                         <a class="mdl-navigation__link mdl-navigation__link--current Blog-menuitem" href="/wildfly-elytron/blog/">Blog</a>
                    
                
                    
                    
                         <a class="mdl-navigation__link GitHub-menuitem" href="https://github.com/wildfly-security/wildfly-elytron">GitHub</a>
                    
                
            </nav>
        </div>
    </header>
    <div class="mdl-layout__drawer">
        <div class="side-drawer-logo-container"><h3>Wild<strong>Fly</strong>  Elytron</h3></div>
        <nav class="mdl-navigation">
            
            
            
                <a class="mdl-navigation__link Home-menuitem" href="/wildfly-elytron/">Home</a>
            
            
            
            
                <a class="mdl-navigation__link Docs-menuitem" href="/wildfly-elytron/docs/">Docs</a>
            
            
            
            
                <a class="mdl-navigation__link Community-menuitem" href="/wildfly-elytron/community/">Community</a>
            
            
            
            
                <a class="mdl-navigation__link mdl-navigation__link--current Blog-menuitem" href="/wildfly-elytron/blog/">Blog</a>
            
            
            
            
                <a class="mdl-navigation__link GitHub-menuitem" href="https://github.com/wildfly-security/wildfly-elytron">GitHub</a>
            
            
            <!-- mdl-navigation__link--current -->
        </nav>
    </div>
    <main class="mdl-layout__content">
        <div class="page-content">
            
            <div class="content">
                <div class="post-page grid-wrapper">
  <div class="grid__item width-12-12 width-12-12-m doc-content">
    <h1>Installing Keycloak OIDC adaptor using the Galleon CLI</h1>
    <div class="grid-wrapper">
      <div class="grid__item width-8-12 width-12-12-m byline-wrapper">
        
        
          <img class="headshot" src="https://www.gravatar.com/avatar/0898ff20f647b8c230f26f9bb3eb7003">
        
        <p class="byline">By <a href="https://github.com/darranl">Darran Lofthouse</a> | July 01, 2021</p>
      </div>
      
      <div class="grid__item width-4-12 width-12-12-m"><div class="share-page">
  <a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://wildfly-security.github.io/wildfly-elytron/blog/galleon-cli-keycloak/&title=Installing Keycloak OIDC adaptor using the Galleon CLI" rel="nofollow" target="_blank" title="Share on LinkedIn">
    <i class="fab fa-linkedin"></i>
  </a>
  <a class="share-twitter" href="https://twitter.com/intent/tweet?text=Installing Keycloak OIDC adaptor using the Galleon CLI&url=https://wildfly-security.github.io/wildfly-elytron/blog/galleon-cli-keycloak/&via=WildFlyAS&related=WildFlyAS" rel="nofollow" target="_blank" title="Share on Twitter">
    <i class="fab fa-twitter-square"></i>
  </a>
  <a class="share-facebook" href="https://facebook.com/sharer.php?u=https://wildfly-security.github.io/wildfly-elytron/blog/galleon-cli-keycloak/" rel="nofollow" target="_blank" title="Share on Facebook">
    <i class="fab fa-facebook-square"></i>
  </a>
  <a class="share-reddit" href="http://www.reddit.com/submit?url=https://wildfly-security.github.io/wildfly-elytron/blog/galleon-cli-keycloak/" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit" >
    <i class="fab fa-reddit-square"></i>
  </a>
  <a class="share-email" href="mailto:?subject=Installing Keycloak OIDC adaptor using the Galleon CLI&amp;body=Installing Keycloak OIDC adaptor using the Galleon CLI https://wildfly-security.github.io/wildfly-elytron/blog/galleon-cli-keycloak/" title="Share via Email" >
    <i class="fas fa-envelope-square"></i>
  </a>
</div>
</div>
      <div class="grid__item width-12-12">
          <div class="paragraph">
<p>Traditionally to install WildFly you would download a complete archive of the application server distribution, unzip it locally
and run it directly from where it was unzipped.  Subsequently to install the Keycloak adaptor for WildFly a second archive would
be downloaded and unzipped on top of the WildFly installation and a CLI script executed to complete the installation.</p>
</div>
<div class="paragraph">
<p>Although this approach has certainly stood the test of time it does have a couple of limitations.  Firstly these steps need to be
repeated each time a new version of the application server or Keycloak adaptors are released.  Secondly the installed application
server contains all of the various supported subsystems even if only a small subset are required.  The Galleon project
provides an alternative installation approach addressing both of these limitations.</p>
</div>
<div class="paragraph">
<p>This blog post illustrates how a slimed WildFly installation can be performed with the addition of the Keycloak client adaptors
using the Galleon command line tools.</p>
</div>
<div class="sect1">
<h2 id="galleon"><a class="anchor" href="#galleon"></a>Galleon</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This blog post is not intended to be a replacment for the already published Galleon documentation, more information can be found in
the <a href="https://docs.wildfly.org/24/Galleon_Guide.html">Galleon Provisioning Guide</a>.</p>
</div>
<div class="paragraph">
<p>This blog post assumes you already have Java 8 or Java 11 installed locally, the first step is to download and unzip the latest release
from the Galleon project to make the CLI tools available.  The latest version can be downloaded from the
<a href="https://github.com/wildfly/galleon/releases">Galleon Releases</a> page.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="installing-the-web-server-layer"><a class="anchor" href="#installing-the-web-server-layer"></a>Installing the "web-server" layer.</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Using the Galleon CLI is a two step process to install a slimmed WildFly server followed by the Keycloak adaptors.</p>
</div>
<div class="paragraph">
<p>The Galleon CLI can be used both in an interactive and non-interactive mode, both of which are covered in more detail in the Galleon
documentation, the examples in this blog post will just be using non-interactive mode.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$GALLEON_HOME/bin/galleon.sh install wildfly:current --dir=wildfly --layers=web-server
Feature pack installed.d.
======= ============ ==============
Product Build        Update Channel
======= ============ ==============
wildfly 24.0.0.Final current</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command will have provisioned a slimed WildFly server which can be used to deploy simple servlet based web applications, this installation
does not have the management interfaces defined so the server can not be configured using the <code>jboss-cli</code>.  However the installation does have
the deployment scanner active so deployments can be added by placing them into the <code>$WILDFLY_HOME/standalone/deployments</code> directory.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="installing-the-keycloak-client-oidc-layer"><a class="anchor" href="#installing-the-keycloak-client-oidc-layer"></a>Installing the "keycloak-client-oidc" layer.</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The next step is to add the <code>keycloak-client-oidc</code> layer on top of the WildFly installation, for the Keycloak specific layers we need to use
the fully qualified Maven group, artifact and version to reference the Keycloak feature pack.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$GALLEON_HOME/bin/galleon.sh install org.keycloak:keycloak-adapter-galleon-pack:14.0.0 --dir=wildfly --layers=keycloak-client-oidc
Feature-packs resolved.
Feature-packs resolved.
Packages installed.
JBoss modules installed.
Configurations generated.
Feature pack installed.</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition to adding the required modules to the WildFly installation this second command will have also added the WildFly Elytron subsystem to
secure deployments by default, the Keycloak adapter subsystem and configuration to make the Keycloak OpenID Connect authentication mechanism available
for deployments.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="starting-wildfly"><a class="anchor" href="#starting-wildfly"></a>Starting WildFly</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At this stage the installation and configuration of WildFly is now complete and the application server can be started.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cd $WILDFLY_HOME
bin/standalone.sh -Djboss.socket.binding.port-offset=10</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are familiar with the usual output when starting the application server you should now see the boot process leads to less output, this is because
only the subsystems required for securing a servlet based web application with Keycloak are now installed so the subsystems which are not required are not
even present.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploying-a-web-application"><a class="anchor" href="#deploying-a-web-application"></a>Deploying a web application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Finally a web application can now be deployed to WildFly.</p>
</div>
<div class="paragraph">
<p>There are two different approaches that can be taken to configure a web application to use the Keycloak OpenID Connect authentication mechanism as described
in <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#jboss-sso">JBoss SSO</a>.</p>
</div>
<div class="paragraph">
<p><em>Note: The preceding section in the Keycloak documentation is skipped as Galleon has replaced the installation steps described there.</em></p>
</div>
<div class="paragraph">
<p>As the installed server does not have the management interfaces enabled the easiest approach to configuration is to embed the configuration within the deployment,
for the Keycloak authentication mechanism this can be achieved by adding a <code>keycloak.json</code> descriptor to the <code>WEB-INF</code> directory of a web application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "realm" : "WildFly",
    "resource" : "simple-webapp",
    "public-client" : "true",
    "auth-server-url" : "http://localhost:8080/auth/",
    "ssl-required" : "EXTERNAL"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The authentication mechanism is activate by setting the <code>auth-method</code> in the <code>web.xml</code> to <code>KEYCLOAK</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">    &lt;login-config&gt;
        &lt;auth-method&gt;KEYCLOAK&lt;/auth-method&gt;
        &lt;realm-name&gt;Simple Realm&lt;/realm-name&gt;
    &lt;/login-config&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>After a web application with these changes is built it can be copied to the <code>standalone\deployments</code> directory of the WildFly installation where it will
be automatically deployed, the application will be secured by Keycloak using the embedded configuration.</p>
</div>
<div class="paragraph">
<p>Additional configuration options are also described in the Keycloak documentation in the
<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_java_adapter_config">Java Adapter Config</a> section, also instead of using the <code>keycloak.json</code>
descriptor the configuration could have been contained in the <code>urn:jboss:domain:keycloak:1.1</code> subsystem as described in <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#securing-wars-via-adapter-subsystem">Securing WARs via Adapter Subsystem</a> but overall the purpose of this blog post was to illustrate how to get started installing the Keycloak client adapters and WildFly using Galleon.</p>
</div>
</div>
</div>
      </div>
    </div>
  </div>
</div>

            </div>
        </div>
    </main>
</div>
</body>
</html>
